<html lang="es" style="--large: 38px;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Entrenador Digital - Mouse y Teclado (Adultos Mayores)</title>
  <style>
    :root{
      --large:32px;
    }
    html,body{height:100%;margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--card)}
    .app{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:18px}
    h1{font-size:36px;margin:0}
    .card{background:rgba(255,255,255,0.06);padding:16px;border-radius:12px;margin-top:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{font-size:22px;padding:12px 18px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:white}
    .btn-secondary{background:transparent;color:var(--card);border:2px solid rgba(255,255,255,0.12)}
    .big{font-size:var(--large)}
    .center{text-align:center}
    .hidden{display:none}
    .practice{margin-top:16px;min-height:320px;display:flex;gap:12px}
    .left{flex:1}
    .right{width:360px}
    .stage{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;height:100%}
    .target{width:70px;height:70px;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;color:var(--bg);font-weight:700;font-size:22px;position:absolute}
    .board{position:relative;background:rgba(255,255,255,0.02);height:480px;border-radius:10px;padding:8px;overflow:hidden}
    .keyboard{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
    .key{background:rgba(255,255,255,0.9);color:var(--bg);padding:12px;border-radius:8px;text-align:center;font-weight:700;user-select:none}
    .key.big{padding:18px;font-size:20px}
    input[type=text]{font-size:28px;padding:14px;width:100%;border-radius:8px;border:0}
    textarea{font-size:28px;padding:14px;width:100%;border-radius:8px;border:0}
    .access{display:flex;gap:8px;align-items:center}
    label{font-size:20px}
    footer{margin-top:16px;font-size:16px;opacity:0.9}
    .status{
      margin-top:16px;
      font-size:26px;
      font-weight: bold;
      min-height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .positive{color:var(--success)}
    .negative{color:var(--error)}
    .help{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px}
    .progress{display:flex;gap:8px;align-items:center}
    .star{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06)}
    .controls-top{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    
    .header-logo {
      width: 72px; height: 72px; border-radius: 12px; background: var(--card);
      display: flex; align-items: center; justify-content: center;
      color: var(--bg); font-weight: 800; font-size: 28px;
    }
    .header-subtitle { opacity: 0.9; }

    .menu-buttons{display:flex;flex-direction:row;gap:24px;margin:24px auto;align-items:stretch;justify-content:center;flex-wrap:wrap}
    .menu-card{width:320px;border:2px solid rgba(255,255,255,0.1);border-radius:12px;padding:0;background:rgba(255,255,255,0.05);display:flex;flex-direction:column;align-items:center;text-align:center;color:white;cursor:pointer;transition:transform .2s,background .2s}
    .menu-card:hover{transform:translateY(-5px);background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.25)}
    .menu-card img{width:100%;height:180px;object-fit:cover;border-top-left-radius:10px;border-top-right-radius:10px}
    .menu-card .card-content{padding:16px;flex-grow:1}
    .menu-card h3{margin:0;font-size:28px}
    .menu-card p{font-size:18px;opacity:.8;margin-top:8px}
    .menu-card .card-icon{font-size:120px;padding-top:30px;height:180px;line-height:1.3}

    .btn-interactive{padding-left:24px;padding-right:24px;background-color:rgba(255,255,255,0.08);border-width:1px;transition:background-color .2s,border-color .2s}
    .btn-interactive:hover{background-color:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.7)}
    
    #btn-repeat-audio { display: flex; align-items: center; gap: 8px; font-size: 18px !important; }
    #free-text { width: 100%; box-sizing: border-box; font-size: 24px; padding: 12px; border-radius: 8px; }

    /* Estilo para la letra dentro de un cuadro */
    .key-display {
      display: inline-block;
      min-width: 80px;
      height: 80px;
      background: var(--card);
      color: var(--bg);
      border: 3px solid var(--card);
      border-radius: 12px;
      font-size: 48px;
      font-weight: bold;
      line-height: 80px;
      text-align: center;
      vertical-align: middle;
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }

    .phrase-box {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      margin: 16px 0;
    }

    .board-menu {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: 10px;
    }

    @media (max-width:900px){.practice{flex-direction:column}.right{width:auto}}

    /* Color-blind friendly themes */
    [data-theme="normal"] {
      --bg: #0b2545;
      --card: #ffffff;
      --accent: #1a73e8;
      --success: #1c9422;
      --error: #c62828;
    }
    [data-theme="protanopia"] {
      --bg: #636D97;
      --card: #EDE6DE;
      --accent: #5A7FBF;
      --success: #2980b9; /* Strong Blue */
      --error: #f1c40f;   /* Yellow */
    }
    [data-theme="deuteranopia"] {
      --bg: #5D6E9E;
      --card: #FADFE2;
      --accent: #4F81C7;
      --success: #00c49a; /* Cyan */
      --error: #ffc107;   /* Yellow */
    }
    [data-theme="tritanopia"] {
      --bg: #212121;
      --card: #F0F0F0;
      --accent: #E91E63;
      --success: #FF9800;
      --error: #C62828;
    }
    [data-theme="acromatopsia"] {
      --bg: #222222;
      --card: #F5F5F5;
      --accent: #9E9E9E;
      --success: #4CAF50;
      --error: #F44336;
    }
  </style>
</head>
<body style="font-size: 20px;">
  <div class="app" role="application" aria-label="Entrenador Digital para manejo de mouse y teclado">
    <header>
      <div class="header-logo">ED</div>
      <div>
        <h1>Entrenador Digital ‚Äî Mouse y Teclado</h1>
        <div class="header-subtitle">Dise√±ado para adultos mayores ¬∑ Modo offline ¬∑ Texto grande y audio de ayuda</div>
      </div>
      <div style="flex:1"></div>
      <button id="btn-home" class="btn-secondary hidden btn-interactive">Men√∫ Principal</button>
    </header>

    <section id="stage-welcome" class="card center">
      <h2 class="big">Modos de Pr√°ctica</h2>
      <div class="menu-buttons">
        <button id="start-mouse" class="menu-card">
          <img src="mouse.jpg" alt="Ilustraci√≥n de un mouse de computadora">
          <div class="card-content">
            <h3>Practicar Mouse</h3>
            <p>Aprende a mover, hacer clic y apuntar con precisi√≥n.</p>
          </div>
        </button>
        <button id="start-key" class="menu-card">
          <img src="teclado.jpg" alt="Ilustraci√≥n de un teclado de computadora">
          <div class="card-content">
            <h3>Practicar Teclado</h3>
            <p>Familiar√≠zate con las teclas y mejora tu velocidad.</p>
          </div>
        </button>
        <button id="start-free" class="menu-card">
          <div class="card-icon">‚úèÔ∏è</div>
          <div class="card-content">
            <h3>Pr√°ctica Libre</h3>
            <p>Usa el teclado y el mouse sin ejercicios guiados.</p>
          </div>
        </button>
      </div>
      <div class="access" style="margin-top: 24px;">
        <label>Modo de Color:</label>
        <button id="color-normal" class="btn-secondary btn-interactive">Normal</button>
        <button id="color-protanopia" class="btn-secondary btn-interactive">Protanopia</button>
        <button id="color-deuteranopia" class="btn-secondary btn-interactive">Deuteranopia</button>
        <button id="color-tritanopia" class="btn-secondary btn-interactive">Tritanopia</button>
        <button id="color-acromatopsia" class="btn-secondary btn-interactive">Acromatopsia</button>
      </div>
    </section>

    <div id="main-content" class="hidden">
      <section class="card">
        <div class="controls">
          <button id="btn-repeat-audio" class="btn-secondary btn-interactive"><span>üîà</span><span>Repetir Audio</span></button>
          <div style="flex:1"></div>
          <div class="access">
            <label for="toggle-audio">Audio</label>
            <input type="checkbox" id="toggle-audio" checked="">
            <label>Tama√±o de texto:</label>
            <button id="btn-decrease-font" class="btn-secondary btn-interactive" aria-label="Reducir tama√±o de texto">A-</button>
            <button id="btn-increase-font" class="btn-secondary btn-interactive" aria-label="Aumentar tama√±o de texto">A+</button>
          </div>

        </div>

        <div class="practice">
          <div class="left">
            <div id="stage-mouse" class="stage hidden">
              <div class="center">
                <h2 class="big">Ejercicio: clic sobre el objetivo</h2>
                <p id="mouse-instruction" style="font-size:20px;opacity:0.95">Sigue las instrucciones.</p>
              </div>
              <div class="board" id="mouse-board" tabindex="0" aria-label="Tablero de pr√°ctica de mouse"></div>
              <div class="status" id="mouse-status"></div>
              <div class="controls-top">
                <button id="btn-reset" class="btn-secondary big btn-interactive">Reiniciar Progreso</button>
                <button id="btn-fullscreen-mouse" class="btn-secondary big btn-interactive">Pantalla Completa</button>
              </div>
            </div>

            <div id="stage-key" class="stage hidden">
              <div class="center">
                <h2 class="big">Ejercicio: presiona la tecla indicada</h2>
                <!-- Solo el cuadro con la letra, sin texto adicional -->
                <div id="key-instruction" style="margin-top:16px;"></div>
              </div>
              <div style="margin-top:12px">
                <div style="display:flex;gap:8px;margin-bottom:12px">
                  <div style="flex:1"><input id="typing-input" type="text" placeholder="Escribe aqu√≠" aria-label="Entrada para practicar teclado"></div>
                </div>
                <div class="keyboard" id="keyboard-visual" aria-hidden="true"></div>
              </div>
              <div class="status" id="key-status"></div>

              <div class="controls-top">
                <button id="btn-previous-key" class="btn-secondary big btn-interactive">Anterior</button>
                <button id="btn-skip-key" class="btn-secondary big btn-interactive">Siguiente</button>
                <button id="btn-reset-key" class="btn-secondary big btn-interactive">Reiniciar Progreso</button>
              </div>
            </div>

            <div id="stage-free" class="stage hidden center">
              <h2 class="big">Pr√°ctica libre</h2>
              <p style="font-size:20px">En el recuadro de texto escribe la siguiente frase:</p>
              <div id="phrase-display" class="phrase-box" style="font-size: 28px; color: white; min-height: 40px;"></div>
              <div style="margin-top:8px">
                <textarea id="free-text" rows="8" placeholder="Escribe aqu√≠..."></textarea>
              </div>
              <div class="status" id="free-status"></div>
              <div class="controls-top">
                 <button id="btn-previous-free" class="btn-secondary big btn-interactive">Anterior</button>
                 <button id="btn-skip-free" class="btn-secondary big btn-interactive">Siguiente</button>
                 <button id="btn-verify-free" class="btn-secondary big btn-interactive">Enviar</button>
                 <button id="btn-reset-free" class="btn-secondary big btn-interactive">Reiniciar Progreso</button>
              </div>
            </div>
          </div>

          <aside class="right">
            <div class="help">
              <h3 class="big">Ayuda r√°pida</h3>
              <ul id="quick-help-list" style="font-size:20px;line-height:1.6">
              </ul>
            </div>
            <div id="levels-card" style="margin-top:12px" class="card hidden">
              <h4 id="level-card-title" class="big">Nivel</h4>
              <div id="level-selector" class="controls" style="justify-content: center; gap: 12px; margin-top: 8px;">
                <button class="btn-secondary btn-interactive level-btn" data-level="1">1</button>
                <button class="btn-secondary btn-interactive level-btn" data-level="2">2</button>
                <button class="btn-secondary btn-interactive level-btn" data-level="3">3</button>
                <button class="btn-secondary btn-interactive level-btn" data-level="4">4</button>
                <button class="btn-secondary btn-interactive level-btn" data-level="5">5</button>
              </div>
            </div>
          </aside>
        </div>
      </section>
    </div>

    <footer>
      <div>Este archivo funciona sin conexi√≥n.</div>
    </footer>
  </div>

    <script>
      // =====================================
      // 1. STATE MANAGEMENT & CONSTANTS
      // =====================================
      const STATE_KEY = 'entrenador_progreso_v1';
      const MIN_FONT_SIZE = 16;
      const MAX_FONT_SIZE = 28;
      const FONT_STEP = 2;
      const audioEnabledDefault = true;

      const helpContent = {
        mouse: [
          'El cursor sigue el movimiento de tu mouse.',
          'Para hacer clic, presiona suavemente el bot√≥n izquierdo del rat√≥n.',
          'Apunta con la punta del cursor al centro del objetivo.'
        ],
        key: [
          'Presiona la tecla que se muestra en pantalla.',
          'Si te equivocas, no pasa nada, solo intenta de nuevo.',
          'Si todo sale en may√∫sculas, revisa la tecla <strong>Bloq May√∫s</strong>.'
        ],
        free: [
          'Escribe la frase que ves en el recuadro.',
          'Usa la tecla de <strong>espacio</strong> para separar las palabras.',
          'Si te equivocas, puedes usar la tecla de <strong>borrar</strong> para corregir.',
          'Recuerda fijarte en las letras que est√°n en may√∫sculas.'
        ],
        default: [
          'El cursor se mueve cuando mueves el mouse.',
          'Para hacer clic, presiona el bot√≥n izquierdo del rat√≥n.',
          'Si todo sale en may√∫sculas, revisa la tecla <strong>Bloq May√∫s</strong>.'
        ]
      };
      
      const phrases = ['Hola Mundo', 'Me gusta aprender', 'Practicar es clave', 'La vida es bella', 'El sol brilla hoy', 'La tecnolog√≠a nos conecta', 'Cada d√≠a es una nueva oportunidad', 'Aprender a usar el computador es √∫til', 'La paciencia es una virtud', 'Disfruta de las peque√±as cosas', 'La Vida Es Un Viaje, No Un Destino', 'El Conocimiento Es Poder', 'La Imaginaci√≥n Es M√°s Importante Que El Saber', 'Aprender Es Crecer Cada D√≠a', 'Nunca Es Tarde Para Empezar Algo Nuevo'];
      const positiveFeedback = ['¬°Muy bien!', '¬°Excelente!', '¬°Correcto!', '¬°Eso es!', '¬°Perfecto!'];

      let state = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
      if (!state.mouse) state.mouse = { level: 1 };
      if (!state.key) state.key = { level: 1 };
      if (!state.theme) state.theme = 'normal';
      if (!state.fontSize) state.fontSize = 20;

      function saveState() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
      
      function resetState() { 
          if(confirm('¬øDesea reiniciar todo el progreso?')){
              state = { mouse: { level: 1 }, key: { level: 1 }, theme: state.theme, fontSize: state.fontSize }; 
              saveState(); 
              speak('Progreso reiniciado');
              if(levelsCard.classList.contains('hidden') === false) {
                  updateLevelUI();
                  if (currentPracticeMode === 'mouse') startMouseExercise();
                  if (currentPracticeMode === 'key') prepareKeyExercise();
              }
          }
      }

      // =====================================
      // 2. DOM ELEMENTS
      // =====================================
      const $ = (s) => document.querySelector(s);
      const stageWelcome = $('#stage-welcome');
      const mainContent = $('#main-content');
      const btnHome = $('#btn-home');
      const btnStartMouse = $('#start-mouse');
      const btnStartKey = $('#start-key');
      const btnStartFree = $('#start-free');
      const stageMouse = $('#stage-mouse');
      const stageKey = $('#stage-key');
      const stageFree = $('#stage-free');
      const mouseBoard = $('#mouse-board');
      const mouseStatus = $('#mouse-status');
      const keyStatus = $('#key-status');
      const typingInput = $('#typing-input');
      const freeText = $('#free-text');
      const freeStatus = $('#free-status');
      const btnRepeatAudio = $('#btn-repeat-audio');
      const levelsCard = $('#levels-card');
      const levelCardTitle = $('#level-card-title');

      // =====================================
      // 3. SPEECH SYNTHESIS
      // =====================================
      let lastSpokenText = '';
      let preferredVoice = null;
  
      function speak(text) {
        const toggle = $('#toggle-audio');
        if (!toggle.checked || !text) return;
        lastSpokenText = text;
        if ('speechSynthesis' in window) {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'es-ES';
          if (preferredVoice) u.voice = preferredVoice;
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        }
      }
  
      function getRandomFeedback() {
        return positiveFeedback[Math.floor(Math.random() * positiveFeedback.length)];
      }
  
      function initSpeech() {
        if (!('speechSynthesis' in window)) return;
        const setVoice = () => {
          const voices = speechSynthesis.getVoices();
          const maleVoiceNames = ['Carlos', 'Miguel', 'Pablo', 'Jorge', 'Diego', 'Antonio', 'es-ES-Standard-B', 'es-ES-Neural2-B', 'Microsoft Pablo - Spanish (Spain)', 'Google espa√±ol'];
          let voice = voices.find(v => v.lang.startsWith('es-') && maleVoiceNames.some(name => v.name.includes(name) || v.name === name));
          if (!voice) voice = voices.find(v => v.lang.startsWith('es-'));
          preferredVoice = voice;
        };
        if (speechSynthesis.getVoices().length > 0) {
          setVoice();
        } else {
          speechSynthesis.onvoiceschanged = () => {
            setVoice();
            speechSynthesis.onvoiceschanged = null;
          };
        }
      }
  
      function getSpokenChar(char) {
          if (char.length !== 1) return char;
          const accents = { '√°': 'a con tilde', '√©': 'e con tilde', '√≠': 'i con tilde', '√≥': 'o con tilde', '√∫': 'u con tilde', '√º': 'u con di√©resis', '√Å': 'A con tilde may√∫scula', '√â': 'E con tilde may√∫scula', '√ç': 'I con tilde may√∫scula', '√ì': 'O con tilde may√∫scula', '√ö': 'U con tilde may√∫scula', '√ú': 'U con di√©resis may√∫scula' };
          if (accents[char]) return accents[char];
          if (char === char.toUpperCase() && char.toLowerCase() !== char) return char + ' may√∫scula';
          const specialChars = { '.': 'punto', ',': 'coma', ';': 'punto y coma', ':': 'dos puntos', '-': 'guion', '_': 'guion bajo', '¬°': 'signo de exclamaci√≥n de apertura', '!': 'signo de exclamaci√≥n', '¬ø': 'signo de interrogaci√≥n de apertura', '?': 'signo de interrogaci√≥n', '@': 'arroba', '#': 'numeral', '$': 'signo de pesos', '%': 'porcentaje', '&': 'y comercial', '/': 'barra', '(': 'par√©ntesis de apertura', ')': 'par√©ntesis de cierre', '=': 'signo de igual', '+': 'signo de m√°s', '*': 'asterisco', '[': 'corchete de apertura', ']': 'corchete de cierre', '{': 'llave de apertura', '}': 'llave de cierre' };
          return specialChars[char] || char;
      }
  
      // =====================================
      // 4. CORE APP & UI LOGIC
      // =====================================
      let currentPracticeMode = '';
  
      function showMainMenu() {
        mainContent.classList.add('hidden');
        stageWelcome.classList.remove('hidden');
        btnHome.classList.add('hidden');
        window.speechSynthesis.cancel();
        cleanupMouseHandlers();
        showStage('');
        updateHelp('default');
        speak('Elige un modo de pr√°ctica.');
      }
      
      function showPracticeView(mode) {
        currentPracticeMode = mode;
        stageWelcome.classList.add('hidden');
        mainContent.classList.remove('hidden');
        btnHome.classList.remove('hidden');
        showStage(mode);
      }
      
      function showStage(s) {
        [stageMouse, stageKey, stageFree].forEach(el => el.classList.add('hidden'));
        levelsCard.classList.add('hidden');
        updateHelp(s || 'default');
        if (s === 'mouse' || s === 'key') {
            levelsCard.classList.remove('hidden');
            levelCardTitle.textContent = s === 'mouse' ? 'Nivel de Mouse' : 'Nivel de Teclado';
            updateLevelUI();
        }
        if (s) $(`#stage-${s}`).classList.remove('hidden');
      }

      function updateHelp(mode) {
        const helpList = $('#quick-help-list');
        const content = helpContent[mode] || helpContent.default;
        helpList.innerHTML = content.map(item => `<li>${item}</li>`).join('');
      }
  
      function updateLevelUI() {
          if (!currentPracticeMode || !['mouse', 'key'].includes(currentPracticeMode)) return;
          const currentLevel = state[currentPracticeMode].level || 1;
          document.querySelectorAll('.level-btn').forEach(btn => {
              const isCurrent = parseInt(btn.dataset.level) === currentLevel;
              btn.classList.toggle('btn-primary', isCurrent);
              btn.classList.toggle('btn-secondary', !isCurrent);
          });
      }
  
      function applyFontSize() {
        const size = state.fontSize || 20;
        document.body.style.fontSize = size + 'px';
        document.documentElement.style.setProperty('--large', (size * 1.9) + 'px');
      }

      function increaseFontSize() {
        let newSize = (state.fontSize || 20) + FONT_STEP;
        if (newSize > MAX_FONT_SIZE) newSize = MAX_FONT_SIZE;
        state.fontSize = newSize;
        applyFontSize();
        saveState();
        speak(`Tama√±o de texto aumentado`);
      }

      function decreaseFontSize() {
        let newSize = (state.fontSize || 20) - FONT_STEP;
        if (newSize < MIN_FONT_SIZE) newSize = MIN_FONT_SIZE;
        state.fontSize = newSize;
        applyFontSize();
        saveState();
        speak(`Tama√±o de texto reducido`);
      }
  
      function setColorMode(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        state.theme = theme;
        saveState();
      }
  
      // =====================================
      // 5. MOUSE EXERCISE
      // =====================================
      let mouseTarget = null;
      let mouseAttempts = 0;
  
      function startMouseExercise() {
        mouseBoard.innerHTML = '';
        mouseStatus.textContent = 'Preparando...';
        const menu = document.createElement('div');
        menu.id = 'mouse-menu';
        menu.className = 'board-menu';
        menu.innerHTML = '<button id="btn-start-mouse-fs" class="btn-primary big">Iniciar Pr√°ctica</button>';
        mouseBoard.appendChild(menu);
        speak('Presiona el bot√≥n Iniciar Pr√°ctica para comenzar.');
        $('#btn-start-mouse-fs').addEventListener('click', () => {
          menu.style.display = 'none';
          spawnTarget();
        });
      }
  
      function spawnTarget() {
        mouseBoard.innerHTML = '';
        const t = document.createElement('div');
        t.className = 'target';
        t.textContent = 'Clic';
        const r = mouseBoard.getBoundingClientRect();
        const baseWidth = Math.max(70, Math.min(140, r.width * 0.15));
        const level = state.mouse.level || 1;
        const reductionFactors = [1.0, 0.85, 0.70, 0.55, 0.45];
        const factor = reductionFactors[level - 1] || 0.45;
        const w = Math.max(20, baseWidth * factor);
        t.style.width = w + 'px';
        t.style.height = w + 'px';
        t.style.fontSize = Math.floor(w * 0.28) + 'px';
        const x = Math.random() * (r.width - w - 12) + 6;
        const y = Math.random() * (r.height - w - 12) + 6;
        t.style.left = x + 'px';
        t.style.top = y + 'px';
        mouseBoard.appendChild(t);
        mouseTarget = t;
        mouseAttempts = 0;
        speak('Haz clic en el c√≠rculo.');
        t.addEventListener('click', onTargetClick);
        mouseBoard.addEventListener('click', onBoardClick);
      }
  
      function onTargetClick(e) {
        e.stopPropagation();
        mouseStatus.innerHTML = '<span class="positive">¬°Muy bien!</span>';
        speak(getRandomFeedback());
        saveState();
        e.target.style.background = 'var(--success)';
        cleanupMouseHandlers();
        setTimeout(spawnTarget, 900);
      }
  
      function onBoardClick(e) {
        if (e.target === mouseBoard) {
          mouseAttempts++;
          mouseStatus.innerHTML = '<span class="negative">Intenta otra vez.</span>';
          speak('Apunta al c√≠rculo y haz clic.');
          if (mouseAttempts >= 4) {
            mouseStatus.innerHTML = '<span class="negative">Har√© el objetivo m√°s grande.</span>';
            const newSize = Math.min(200, mouseTarget.offsetWidth * 1.5);
            mouseTarget.style.width = newSize + 'px';
            mouseTarget.style.height = newSize + 'px';
            mouseTarget.style.fontSize = Math.floor(newSize * 0.3) + 'px';
          }
        }
      }
  
      function cleanupMouseHandlers() {
        if (mouseTarget) mouseTarget.removeEventListener('click', onTargetClick);
        mouseBoard.removeEventListener('click', onBoardClick);
      }
  
      // =====================================
      // 6. KEYBOARD EXERCISE
      // =====================================
      let expected = '';
      let letterHistory = [];
      let futureLetters = [];
  
      function prepareKeyExercise() {
        typingInput.value = '';
        keyStatus.textContent = '';
        letterHistory = [];
        futureLetters = [];
        expected = randomLetter();
        highlightExpected(expected);
        speak('Presiona la tecla ' + getSpokenChar(expected));
      }

      function nextKey() {
        if (expected) letterHistory.push(expected);
        expected = (futureLetters.length > 0) ? futureLetters.pop() : randomLetter();
        highlightExpected(expected);
        speak('Ahora: ' + getSpokenChar(expected));
        typingInput.value = '';
        keyStatus.textContent = '';
      }

      function previousKey() {
        if (letterHistory.length > 0) {
          if (expected) futureLetters.push(expected);
          expected = letterHistory.pop();
          highlightExpected(expected);
          speak('Anterior: ' + getSpokenChar(expected));
          typingInput.value = '';
          keyStatus.textContent = '';
        } else {
          speak('No hay letras anteriores.');
        }
      }
  
      function randomLetter() {
        const level = state.key.level || 1;
        let charSet = 'abcdefghijklmn√±opqrstuvwxyz';
        if (level >= 2) charSet += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (level >= 3) charSet += '√°√©√≠√≥√∫√º√Å√â√ç√ì√ö√ú';
        if (level >= 4) charSet += '0123456789';
        if (level >= 5) charSet += '.,;:-_¬°!¬ø?@#$%&/()=+*[]{}';
        let nextLetter;
        const lastLetter = letterHistory.length > 0 ? letterHistory[letterHistory.length - 1] : null;
        do {
          nextLetter = charSet[Math.floor(Math.random() * charSet.length)];
        } while (charSet.length > 1 && nextLetter === lastLetter);
        return nextLetter;
      }
  
      function highlightExpected(ch) {
        $('#key-instruction').innerHTML = `<span class="key-display">${ch}</span>`;
      }

      function handleKeyPracticeInput(e) {
        if (e.getModifierState && e.getModifierState('CapsLock')) {
          keyStatus.innerHTML = '<span class="negative">May√∫scula activada.</span>';
          speak('May√∫scula activada');
        }
        const pressed = e.key;
        if (pressed === expected) {
          keyStatus.innerHTML = `<span class="positive">${getRandomFeedback()}</span>`;
          speak('Correcto');
          saveState();
          setTimeout(nextKey, 400);
          e.preventDefault();
        } else if (e.key.length === 1 && /[a-zA-Z√±√ë]/.test(e.key)) {
          keyStatus.innerHTML = `<span class="negative">Incorrecto. Intenta: ${expected}</span>`;
          speak('Esa no es. Intenta de nuevo.');
        }
      }
  
      // =====================================
      // 7. FREE PRACTICE EXERCISE
      // =====================================
      let currentPhrase = '';
      let currentPool = [...phrases];
      let phraseHistory = [];
      let lastTyped = '';
  
      function startFreePractice() {
        if (currentPool.length === 0) currentPool = [...phrases];
        const index = Math.floor(Math.random() * currentPool.length);
        const newPhrase = currentPool.splice(index, 1)[0];
        if (currentPhrase) phraseHistory.push(currentPhrase);
        currentPhrase = newPhrase;
        freeText.value = '';
        $('#phrase-display').textContent = currentPhrase;
        freeText.placeholder = 'Escribe la frase de arriba...';
        freeStatus.innerHTML = '';
        speak('Escribe la frase: ' + currentPhrase);
      }

      function showPreviousPhrase() {
        if (phraseHistory.length > 0) {
          currentPool.push(currentPhrase);
          currentPhrase = phraseHistory.pop();
          freeText.value = '';
          $('#phrase-display').textContent = currentPhrase;
          freeStatus.innerHTML = '';
          speak('Frase anterior: ' + currentPhrase);
        } else {
          speak('No hay frases anteriores.');
        }
      }

      function verifyPhrase() {
        const typed = freeText.value;
        if (typed === currentPhrase) {
          freeStatus.innerHTML = '<span class="positive">¬°Frase correcta!</span>';
          speak('Correcto. Pulsa Siguiente para otra frase.');
        } else {
          freeStatus.innerHTML = '<span class="negative">La frase no es correcta. Intenta de nuevo.</span>';
          speak('La frase no es correcta. Intenta de nuevo.');
        }
      }

      function handleFreePracticeInput(e) {
        const typed = e.target.value;
        if (typed.length < lastTyped.length) {
          lastTyped = typed;
          return;
        }
        if (!currentPhrase.startsWith(typed)) {
          freeStatus.innerHTML = '<span class="negative">Cuidado, vas por mal camino.</span>';
          speak('Cuidado');
        } else {
          freeStatus.innerHTML = '';
        }
        lastTyped = typed;
      }
  
      // =====================================
      // 8. INITIALIZATION
      // =====================================
      function bindEventListeners() {
        btnStartMouse.addEventListener('click', () => { showPracticeView('mouse'); startMouseExercise(); });
        btnStartKey.addEventListener('click', () => { showPracticeView('key'); prepareKeyExercise(); });
        btnStartFree.addEventListener('click', () => { showPracticeView('free'); startFreePractice(); });
        btnHome.addEventListener('click', showMainMenu);
        btnRepeatAudio.addEventListener('click', () => { if (lastSpokenText) speak(lastSpokenText); });
        
        $('#btn-increase-font').addEventListener('click', increaseFontSize);
        $('#btn-decrease-font').addEventListener('click', decreaseFontSize);

        ['normal', 'protanopia', 'deuteranopia', 'tritanopia', 'acromatopsia'].forEach(theme => {
            $(`#color-${theme}`).addEventListener('click', () => setColorMode(theme));
        });

        $('#btn-reset').addEventListener('click', resetState);
        $('#btn-fullscreen-mouse').addEventListener('click', () => {
            if (mouseBoard.requestFullscreen) mouseBoard.requestFullscreen();
            else if (mouseBoard.webkitRequestFullscreen) mouseBoard.webkitRequestFullscreen();
            else if (mouseBoard.msRequestFullscreen) mouseBoard.msRequestFullscreen();
        });

        $('#btn-previous-key').addEventListener('click', previousKey);
        $('#btn-skip-key').addEventListener('click', nextKey);
        $('#btn-reset-key').addEventListener('click', resetState);
        
        $('#btn-previous-free').addEventListener('click', showPreviousPhrase);
        $('#btn-skip-free').addEventListener('click', startFreePractice);
        $('#btn-verify-free').addEventListener('click', verifyPhrase);
        $('#btn-reset-free').addEventListener('click', resetState);

        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!currentPracticeMode || !['mouse', 'key'].includes(currentPracticeMode)) return;
                const newLevel = parseInt(btn.dataset.level);
                state[currentPracticeMode].level = newLevel;
                saveState();
                updateLevelUI();
                speak(`Nivel ${newLevel} seleccionado.`);
                if (currentPracticeMode === 'mouse') {
                    cleanupMouseHandlers();
                    startMouseExercise();
                } else if (currentPracticeMode === 'key') {
                    prepareKeyExercise();
                }
            });
        });

        typingInput.addEventListener('keydown', handleKeyPracticeInput);
        freeText.addEventListener('input', handleFreePracticeInput);
        freeText.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyPhrase();
            }
        });

        window.addEventListener('beforeunload', saveState);
      }

      function init() {
        $('#toggle-audio').checked = audioEnabledDefault;
        document.documentElement.setAttribute('data-theme', state.theme || 'normal');
        applyFontSize();
        initSpeech();
        bindEventListeners();
        showMainMenu();
        buildKeyboardVisual(); // Placeholder for keyboard visualization
      }
      
      function buildKeyboardVisual() { /* ... */ }

      window.addEventListener('load', init);
    </script>
</body>
</html>
